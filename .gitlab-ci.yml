stages:
    - build
    - deploy

publish-org:
    stage: build
    image: iquiw/alpine-emacs
    before_script:
        - apk add --no-cache --update sqlite git
    script:
        - emacs -Q --batch -l build-site.el --funcall jh/publish-org
    cache:
        key: .emacs.d-cache-$CI_COMMIT_REF_SLUG
        paths:
        - public
        - org
        - .emacs.d/
        

generate-css:
    stage: build
    needs: [publish-org]
    image: node:latest
    script:
        - npm ci
        - npm run build-css:production
    cache:
        key: $CI_COMMIT_REF_SLUG
        paths:
        - .npm/



publish-assets:    
    stage: build
    image: iquiw/alpine-emacs
    needs: [publish-org, generate-css]
    before_script:
        - apk add --no-cache --update sqlite git
    script:
        - emacs -Q --batch -l build-site.el --funcall jh/publish-assets
    artifacts:
        paths:
        - static

pages:
    stage: deploy
    needs: [publish-org, publish-assets]
    image: iquiw/alpine-emacs
    before_script:
        - apk add --no-cache --update sqlite git
    script:
        - emacs -Q --batch -l build-site.el --funcall org-publish-all
    artifacts:
        paths:
            - public
